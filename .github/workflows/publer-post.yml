name: Auto-post new blog articles to social media

on:
  push:
    branches:
      - main
    paths:
      - 'src/data/blog/index.ts'

jobs:
  post-to-social:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Detect new blog post and post to Publer
        env:
          PUBLER_API_TOKEN: ${{ secrets.PUBLER_API_TOKEN }}
          PUBLER_WORKSPACE_ID: ${{ secrets.PUBLER_WORKSPACE_ID }}
          PUBLER_ACCOUNT_IDS: ${{ secrets.PUBLER_ACCOUNT_IDS }}
          SITE_URL: 'https://spesti.app'
        run: |
          node - <<'EOF'
          const { execSync } = require('child_process');
          const fs = require('fs');

          // Get the previous version of blog/index.ts
          let prevContent = '';
          try {
            prevContent = execSync('git show HEAD~1:src/data/blog/index.ts', { encoding: 'utf8' });
          } catch {
            console.log('No previous version found (first commit)');
          }

          const currentContent = fs.readFileSync('src/data/blog/index.ts', 'utf8');

          // Extract slugs from content using regex
          function extractSlugs(content) {
            const matches = [...content.matchAll(/slug:\s*["'`]([^"'`]+)["'`]/g)];
            return new Set(matches.map(m => m[1]));
          }

          const prevSlugs = extractSlugs(prevContent);
          const currentSlugs = extractSlugs(currentContent);

          const newSlugs = [...currentSlugs].filter(s => !prevSlugs.has(s));
          console.log('New blog post slugs:', newSlugs);

          if (newSlugs.length === 0) {
            console.log('No new blog posts detected. Skipping social post.');
            process.exit(0);
          }

          // Extract post details for the first new slug
          const slug = newSlugs[0];

          // Extract title for this slug
          const titleMatch = currentContent.match(
            new RegExp(`slug:\\s*["'\`]${slug}["'\`][\\s\\S]*?title:\\s*["'\`]([^"'\`]+)["'\`]`)
          );
          const title = titleMatch ? titleMatch[1] : slug;

          // Extract description
          const descMatch = currentContent.match(
            new RegExp(`slug:\\s*["'\`]${slug}["'\`][\\s\\S]*?description:\\s*["'\`]([^"'\`]+)["'\`]`)
          );
          const description = descMatch ? descMatch[1] : '';

          const url = `${process.env.SITE_URL}/blog/${slug}`;

          // Build the post text (keep under 280 chars for Twitter)
          const shortDesc = description.length > 150
            ? description.substring(0, 147) + '...'
            : description;

          const postText = `${title}\n\n${shortDesc}\n\n${url}`;
          const fullText = `ðŸ“Š ${title}\n\n${description}\n\nðŸ”— ${url}\n\n#ÑÐ¿ÐµÑÑ‚Ð¸ #Ñ„Ð¸Ð½Ð°Ð½ÑÐ¸ #Bulgaria`;

          console.log('Posting article:', title);
          console.log('URL:', url);

          // Parse account IDs (comma-separated)
          const accountIds = process.env.PUBLER_ACCOUNT_IDS.split(',').map(id => id.trim()).filter(Boolean);

          if (accountIds.length === 0) {
            console.error('No PUBLER_ACCOUNT_IDS configured!');
            process.exit(1);
          }

          // Post immediately (state: "published")
          // Schedule 5 min from now as fallback
          const scheduledAt = new Date(Date.now() + 5 * 60 * 1000).toISOString();

          const body = {
            bulk: {
              state: 'published',
              posts: accountIds.map(accountId => ({
                networks: {
                  // Will be overridden per network type by Publer
                  // Using generic "text" type works for all platforms
                  link: {
                    text: fullText,
                    url: url,
                  }
                },
                accounts: [
                  {
                    id: accountId,
                    scheduled_at: scheduledAt,
                  }
                ]
              }))
            }
          };

          // Actually, Publer expects a single post with multiple accounts
          const singleBody = {
            bulk: {
              state: 'published',
              posts: [
                {
                  text: fullText,
                  link: url,
                  accounts: accountIds.map(id => ({
                    id: id,
                    scheduled_at: scheduledAt,
                  }))
                }
              ]
            }
          };

          const response = await fetch('https://app.publer.com/api/v1/posts/schedule', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer-API ${process.env.PUBLER_API_TOKEN}`,
              'Publer-Workspace-Id': process.env.PUBLER_WORKSPACE_ID,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(singleBody),
          });

          const result = await response.json();
          console.log('Publer API response:', JSON.stringify(result, null, 2));

          if (!response.ok) {
            console.error('Publer API error:', response.status, result);
            process.exit(1);
          }

          console.log('Successfully posted to social media! Job ID:', result.job_id);

          // If there are more new slugs, log them
          if (newSlugs.length > 1) {
            console.log(`Note: ${newSlugs.length - 1} more new posts not auto-posted:`, newSlugs.slice(1));
          }
          EOF
